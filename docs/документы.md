# CompliSec — Модуль «Документы»

ТЗ/бриф для Cursor AI: создать модуль управления нормативными и внутренними документами с поддержкой версионирования, согласований, ознакомлений сотрудников и ИИ‑аналитики. Модуль должен быть мультиорганизационным (multi‑tenant) и интегрироваться с остальной платформой CompliSec.

---

## 1) Цели и функции

* Хранение и каталог документов (политики, стандарты, регламенты, инструкции, акты, т.п.).
* Версионирование: черновик → на согласовании → утверждён → архив/устарел.
* Рабочие процессы:

  * Согласование и утверждение (маршрут по ролям).
  * Ознакомление сотрудников (ack) с учётом квиза (3–5 вопросов, опционально).
* Метаданные: тип, категории, теги, связка с активами, рисками, контролями.
* Поиск по полнотекстовому индексу и фильтрам.
* Мультиорганизационность (org_id), строгий RBAC.
* Интеграция с ИИ: классификация документа, извлечение требований, авто‑черновик карты соответствия (ISO/СТ‑РК), OCR для PDF/DOCX.
* Объектное хранилище (S3‑совместимое или локальное), антивирусная проверка, генерация предпросмотра/текста.
* **Материалы для обучения** (отдельный поток):

  * Загружаются в отдельный раздел `training_materials`.
  * Могут быть документами, презентациями, видео.
  * Привязываются к документам или публикуются как самостоятельные курсы.
  * Поддержка ACK + квиза для проверки изучения.

---

## 2) Роли и доступа (RBAC)

* Роли динамические: администратор может создавать собственные роли и назначать им права.
* Все права задаются через policy‑модель (например, в `rbac/policies/*.policy.ts`).
* Базовые роли (можно переопределить):

  * **OrgAdmin** — управление оргой, настройками, шаблонами.
  * **SecurityOfficer** — создание/редактирование документов, маршруты согласования, публикация.
  * **DocumentOwner** — владелец конкретного документа, инициатор версий и согласований.
  * **Approver** — согласующий по маршруту.
  * **Employee** — читает опубликованные, проходит ознакомление/квиз.
  * **Auditor** — доступ к опубликованным документам и журналам аудита.
* Любая организация может создать свою роль и назначить granular‑права (например: «просмотр только обучающих материалов», «только запуск ACK‑кампаний»).

---

## 3) Архитектура и файловая структура (рекомендация)

```
backend/
  cmd/complisec-api/main.go
  internal/
    http/
      handlers/documents/*
      handlers/training/*
      middleware/tenant.go
      middleware/authz.go
    services/
      documents/
      training/
    repository/
      documents/
      training/
    models/
      documents.go
      training.go
    queue/
      worker.go
  pkg/
    s3/
    ocr/
    antivirus/
    ai/
  migrations/
    001_init_documents.sql
    002_init_training.sql
    003_ft_search.sql
  openapi/
    documents.yaml
    training.yaml

frontend/
  src/
    pages/docs/*
    pages/training/*
    components/docs/*
    components/training/*
    api/documents.ts
    api/training.ts
    rbac/withPermission.tsx
    store/documents.slice.ts
    store/training.slice.ts
```

---

## 4) Данные и схема БД (PostgreSQL)

**Требования:** все таблицы имеют `org_id`, soft‑delete через `deleted_at`, аудит через триггеры.

### Документы

*(без изменений, см. предыдущую версию)*

### Материалы для обучения

```sql
CREATE TABLE training_materials (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  title TEXT NOT NULL,
  description TEXT,
  type TEXT NOT NULL,              -- document|video|presentation|other
  storage_key TEXT NOT NULL,
  mime_type TEXT,
  size_bytes BIGINT,
  checksum_sha256 TEXT,
  created_by UUID NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  deleted_at TIMESTAMPTZ
);

CREATE TABLE training_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  material_id UUID NOT NULL REFERENCES training_materials(id),
  user_id UUID NOT NULL,
  deadline DATE,
  passed_quiz BOOLEAN DEFAULT false,
  score INT,
  completed_at TIMESTAMPTZ
);
```

---

## 5) Бизнес‑процессы и состояния (обновлено)

* Документы: draft → in_review → approved → obsolete.
* Ознакомления (ACK) остаются.
* **Обучающие материалы**:

  * Загружаются отдельно.
  * Назначаются пользователям или группам.
  * Сопровождаются квизом.
  * Отчёты: прогресс выполнения по каждому пользователю.

---

## 6) Остальное

(остальные секции остаются как в предыдущей версии, с учётом добавления training‑модуля и динамических ролей).

---

## 17) GAP и правки (по скриншоту)

**Диагностика несоответствий:**

1. Диалог «Создать документ» содержит только 4 поля (Название, Описание, Тип, Категория). По ТЗ (§8) отсутствуют: `Код`, `Теги`, `Владелец`, `Связанные активы/риски/контроли`, `Классификация`, `Дата вступления в силу`, `Период пересмотра`.
2. Нет шага загрузки версии файла при создании — по ТЗ первая версия должна загружаться сразу и проходить AV+OCR.
3. Нет мастера маршрута согласования (последовательный/параллельный), только создание без submit на review.
4. Нет статуса и таймлайна версий/согласований на карточке документа.
5. Нет раздела «Материалы для обучения» (требование из §1 и обновления об отдельной загрузке training‑материалов).
6. Нет кнопок «Отправить на согласование», «Утвердить/Отклонить», «Опубликовать», «Создать кампанию ознакомления».
7. Нет интеграции с квизами (привязка квиза к публикации/кампании).
8. Фильтры/поиск и колонки списка документов не соответствуют ТЗ.

---

## 18) ТЗ на правку UI: `CreateDocumentWizard`

Реализовать мастер (Stepper, 3 шага). Компонент: `components/docs/CreateDocumentWizard.tsx`.

### Шаг 1 — Метаданные

Поля:

* `title*`, `code`, `doc_type*` (select), `category` (select), `tags` (chips), `owner_id*` (user select),
* `asset_ids` (multi‑select), `risk_ids` (multi‑select), `control_ids` (multi‑select),
* `classification` (Public|Internal|Confidential), `effective_from` (date), `review_period_months` (int),
* Read‑only: `status = draft`, `org_id` из сессии.
  Кнопка: **Далее** → создаёт документ через `POST /orgs/{orgId}/documents` (см. §7) и переходит к шагу 2.

### Шаг 2 — Загрузка версии

UI: `Dropzone`, прогресс, ограничения размера, допустимые типы: pdf|docx. Опции: `Enable OCR`, отображение AV‑скана.
Действия:

* Загрузка → `POST /orgs/{orgId}/documents/{id}/versions` (multipart).
* После `201` показать: имя файла, размер, checksum, статус AV/OCR, предпросмотр/извлечённый текст.
  Кнопки: **Назад**, **Далее**.

### Шаг 3 — Маршрут согласования

UI‑конструктор: режим `sequential|parallel`, список шагов, выбор `approver_id` на каждом шаге, дедлайны шагов (опц.).
Кнопки: **Сохранить как шаблон маршрута (опц.)**, **Отправить на согласование** → `POST /orgs/{orgId}/documents/{id}/submit` с `{ route: [...] }`.

### После отправки

Редирект на `/docs/[id]`, где доступны:

* Таймлайн версий (`VersionTimeline`), `ApprovalFlow`, `DocViewer`.
* Кнопка **Опубликовать** (только после полного approve) → `POST /publish`.
* Диалог **Создать кампанию ознакомления** с выбором аудитории, дедлайна и привязкой квиза (см. §7).

---

## 19) Дополнения по разделам/навигации

* Добавить вкладку **Обучающие материалы** рядом с «Документы | Ознакомления | Квизы». Страница `/training` с таблицей и кнопкой «Загрузить материал». Использовать таблицы `training_materials`, `training_assignments` (§4).
* В списке документов добавить колонки: **Код**, **Тип**, **Статус**, **Версия**, **Владелец**, **Обновлён**, **Теги**; фильтры по статусу, типу, тегам, фулл‑текст.

---

## 20) Привязка к API

* List/Create/Update — как в §7 `documents.yaml`.
* Upload version — `POST /versions` (multipart).
* Submit/Approve/Publish — эндпойнты §7.
* Create ACK campaign — `POST /ack-campaigns` с `audience`, `deadline`, `quizId`.
* Training — `training.yaml` (list/upload/assign).

---

## 21) Acceptance Criteria (UI)

1. Мастер создания документа в 3 шага; нельзя завершить без загруженной версии.
2. AV‑скан и (при включённом OCR) извлечение текста выполняются и визуально отражаются.
3. Конструктор маршрута согласования сохраняет последовательный/параллельный шаги и корректно отправляет `submit`.
4. На карточке документа отображаются: статус, последняя версия, таймлайн согласований, кнопки Publish/ACK.
5. Вкладка «Обучающие материалы» присутствует и допускает загрузку/назначение.
6. Фильтры и колонки списка соответствуют ТЗ.

---

## 22) Тест‑кейсы (E2E)

* Создание документа → загрузка версии → submit → один approver отклоняет → правка/новая версия → повторное submit → оба approve → publish → ACK‑кампания с квизом → сотрудник проходит ≥80%.
* Права: роль без `documents.create` не видит кнопку «Создать документ», роль `Approver` видит экран согласования.

---

## 23) Пример компонентов (фрагмент)

```tsx
// components/docs/CreateDocumentWizard.tsx (скелет)
export default function CreateDocumentWizard() {
  const [step, setStep] = useState(0);
  const [docId, setDocId] = useState<string | null>(null);
  return (
    <Card className="p-6">
      <Stepper activeStep={step}>
        <Step>Метаданные</Step>
        <Step>Версия</Step>
        <Step>Согласование</Step>
      </Stepper>
      {step===0 && <MetaForm onSuccess={(id)=>{setDocId(id); setStep(1);}}/>}
      {step===1 && docId && <VersionUpload docId={docId} onNext={()=>setStep(2)} onBack={()=>setStep(0)} />}
      {step===2 && docId && <ApprovalRouteBuilder docId={docId} onSubmitSuccess={(id)=>router.push(`/docs/${id}`)} />}
    </Card>
  );
}
```

---

## 24) Разбивка на PR

1. Wizard + API вызовы (создать/версия/submit).
2. Карточка документа: таймлайн/flow/кнопки publish+ACK.
3. Листинг + фильтры/поиск.
4. Вкладка «Обучающие материалы».
5. E2E тесты + фикстуры.
